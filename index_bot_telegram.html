<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Calc Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f2f2f7; color: #000; }
        
        #canvas-container { position: absolute; top: 0; left: 0; width: 100vw; height: 55vh; z-index: 1; background: #e5e5ea; }
        
        #ui-layer { 
            position: absolute; top: 55vh; left: 0; width: 100%; height: 45vh; z-index: 10; 
            background: white; border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; padding: 20px; overflow-y: auto;
        }

        /* –¶—ñ–Ω–∞ —Ç–∞ –Ü–Ω—Ñ–æ */
        .header-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .price-big { font-size: 28px; font-weight: 800; color: #007aff; }
        .stats-small { font-size: 13px; color: #8e8e93; text-align: right; }

        /* –°—ñ—Ç–∫–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .control-group { display: flex; flex-direction: column; }
        .label { font-size: 11px; font-weight: 600; text-transform: uppercase; color: #8e8e93; margin-bottom: 4px; letter-spacing: 0.5px; }
        
        select {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #c7c7cc;
            background: #f2f2f7; font-size: 15px; font-weight: 500; appearance: none;
            color: #000; outline: none;
        }
        select:focus { border-color: #007aff; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-container { margin-top: auto; }
        .btn { 
            display: flex; justify-content: center; align-items: center; width: 100%; 
            padding: 16px; border: none; border-radius: 14px; 
            font-size: 17px; font-weight: 600; cursor: pointer; 
            transition: 0.1s; margin-top: 8px;
        }
        .btn:active { transform: scale(0.98); opacity: 0.8; }
        
        .btn-main { background: #007aff; color: white; }
        .btn-sec { background: #e5e5ea; color: #007aff; }
        .btn-loading { background: #8e8e93; color: white; pointer-events: none; }

        /* –ó–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á —Ç–∞ —Å—Ç–∞—Ä—Ç–æ–≤–∏–π –µ–∫—Ä–∞–Ω */
        #upload-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.9); z-index: 20;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #loader { display: none; font-weight: 600; color: #007aff; margin-top: 10px; }
        
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer" style="display:none;">
        <div class="header-info">
            <div class="price-big"><span id="price">0</span> –≥—Ä–Ω</div>
            <div class="stats-small">
                <div>–û–±'—î–º: <b id="vol">0</b> —Å–º¬≥</div>
                <div>–í–∞–≥–∞: <b id="weight">0</b> –≥</div>
            </div>
        </div>

        <div class="settings-grid">
            <div class="control-group">
                <span class="label">–ú–∞—Ç–µ—Ä—ñ–∞–ª</span>
                <select id="material">
                    <option value="PLA" data-cost="3.5" data-dens="1.24">PLA (–ï–∫–æ)</option>
                    <option value="PETG" data-cost="3.5" data-dens="1.27">PETG (–ú—ñ—Ü–Ω–∏–π)</option>
                    <option value="ABS" data-cost="4.0" data-dens="1.04">ABS (–¢–µ—Ö–Ω—ñ—á–Ω–∏–π)</option>
                    <option value="TPU" data-cost="6.0" data-dens="1.21">TPU (–ì–Ω—É—á–∫–∏–π)</option>
                </select>
            </div>
            <div class="control-group">
                <span class="label">–ö–æ–ª—ñ—Ä</span>
                <select id="color">
                    <option value="–ß–æ—Ä–Ω–∏–π">‚ö´ –ß–æ—Ä–Ω–∏–π</option>
                    <option value="–ë—ñ–ª–∏–π">‚ö™ –ë—ñ–ª–∏–π</option>
                    <option value="–°—ñ—Ä–∏–π">üîò –°—ñ—Ä–∏–π</option>
                    <option value="–Ü–Ω—à–∏–π">üåà –Ü–Ω—à–∏–π</option>
                </select>
            </div>
            <div class="control-group">
                <span class="label">–ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è</span>
                <select id="infill">
                    <option value="20">20% (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
                    <option value="50">50% (–ú—ñ—Ü–Ω–∏–π)</option>
                    <option value="100">100% (–õ–∏—Ç–∏–π)</option>
                    <option value="0">0% (–ü—É—Å—Ç–∏–π)</option>
                </select>
            </div>
            <div class="control-group">
                <span class="label">–Ø–∫—ñ—Å—Ç—å (–®–∞—Ä)</span>
                <select id="quality">
                    <option value="0.2">0.2 –º–º (Norm)</option>
                    <option value="0.1">0.1 –º–º (High)</option>
                    <option value="0.3">0.3 –º–º (Draft)</option>
                </select>
            </div>
        </div>

        <div class="btn-container">
            <button class="btn btn-main" id="confirm-btn" onclick="uploadAndClose()">‚úÖ –ó–∞–º–æ–≤–∏—Ç–∏ –¥—Ä—É–∫</button>
            <label for="file-upload" class="btn btn-sec">üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ–Ω—à–∏–π —Ñ–∞–π–ª</label>
        </div>
    </div>

    <div id="upload-overlay">
        <label for="file-upload" class="btn btn-main" style="width: 200px;">üìÇ –û–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª</label>
        <div id="loader">‚è≥ –û–±—Ä–æ–±–∫–∞ –º–æ–¥–µ–ª—ñ...</div>
    </div>
    <input type="file" id="file-upload" accept=".stl,.obj">

    <script type="module">
        import * as THREE from 'three';
        import { STLLoader } from 'three/addons/loaders/STLLoader.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const tg = window.Telegram.WebApp;
        tg.expand();

        let scene, camera, renderer, mesh;
        let baseVolume = 0;
        let selectedFile = null;
        let orderData = {};

        // –°–ª—É—Ö–∞—î–º–æ –∑–º—ñ–Ω–∏ —É –≤—Å—ñ—Ö —Å–µ–ª–µ–∫—Ç–æ—Ä–∞—Ö
        document.querySelectorAll('select').forEach(el => {
            el.addEventListener('change', calculatePrice);
        });

        init();

        function init() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene(); scene.background = new THREE.Color(0xe5e5ea);
            
            // –°–≤—ñ—Ç–ª–æ
            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 10, 10);
            scene.add(dirLight);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / (window.innerHeight * 0.55), 0.1, 1000);
            camera.position.set(50, 50, 50);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight * 0.55);
            container.appendChild(renderer.domElement);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;

            animate();
            
            function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É
        document.getElementById('file-upload').addEventListener('change', function(e) {
            selectedFile = e.target.files[0];
            if (!selectedFile) return;

            document.getElementById('loader').style.display = 'block';
            
            const reader = new FileReader();
            const ext = selectedFile.name.split('.').pop().toLowerCase();

            reader.onload = function(event) {
                try {
                    if (mesh) scene.remove(mesh);
                    const content = event.target.result;
                    
                    if (ext === 'stl') {
                        const geometry = new STLLoader().parse(content);
                        showModel(geometry);
                    } else if (ext === 'obj') {
                        const object = new OBJLoader().parse(content);
                        let geometry = null;
                        object.traverse(child => { if (child.isMesh) geometry = child.geometry; });
                        if (geometry) showModel(geometry);
                    }
                } catch (err) { alert('–ü–æ–º–∏–ª–∫–∞: ' + err); }
                document.getElementById('loader').style.display = 'none';
            };

            if (ext === 'stl') reader.readAsArrayBuffer(selectedFile); else reader.readAsText(selectedFile);
        });

        function showModel(geometry) {
            geometry.computeBoundingBox(); geometry.center();
            
            // –ú–∞—Ç–µ—Ä—ñ–∞–ª –º–æ–¥–µ–ª—ñ
            const material = new THREE.MeshStandardMaterial({ color: 0x007aff, roughness: 0.5 });
            mesh = new THREE.Mesh(geometry, material);
            mesh.rotation.x = -Math.PI / 2;
            
            // –°—Ç–∞–≤–∏–º–æ –Ω–∞ "–ø—ñ–¥–ª–æ–≥—É"
            geometry.computeBoundingBox();
            mesh.position.y = -geometry.boundingBox.min.z;
            scene.add(mesh);

            // –ö–∞–º–µ—Ä–∞
            const size = geometry.boundingBox.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            camera.position.set(maxDim*2, maxDim*2, maxDim*2);
            camera.lookAt(0,0,0);

            // –û–±'—î–º
            baseVolume = getVolume(geometry);
            
            // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('upload-overlay').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
            
            calculatePrice();
        }

        function getVolume(geometry) {
            let vol = 0; const pos = geometry.attributes.position;
            const p1 = new THREE.Vector3(), p2 = new THREE.Vector3(), p3 = new THREE.Vector3();
            for(let i=0; i<pos.count; i+=3) {
                p1.fromBufferAttribute(pos, i); p2.fromBufferAttribute(pos, i+1); p3.fromBufferAttribute(pos, i+2);
                vol += p1.dot(p2.cross(p3)) / 6.0;
            }
            return Math.abs(vol) / 1000; // —Å–º3
        }

        function calculatePrice() {
            if (!baseVolume) return;

            const matSelect = document.getElementById('material');
            const infillVal = parseInt(document.getElementById('infill').value);
            const qualityVal = parseFloat(document.getElementById('quality').value);

            // –î–∞–Ω—ñ –∑ –æ–ø—Ü—ñ–π
            const costPerGram = parseFloat(matSelect.options[matSelect.selectedIndex].getAttribute('data-cost'));
            const density = parseFloat(matSelect.options[matSelect.selectedIndex].getAttribute('data-dens'));

            // 1. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–∞–≥–∏ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
            // –°—Ç—ñ–Ω–∫–∏ –∑–∞–π–º–∞—é—Ç—å ~40%, —Ä–µ—à—Ç–∞ 60% –∑–∞–ª–µ–∂–∞—Ç—å –≤—ñ–¥ % –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
            let solidFactor = 0.4 + (0.6 * (infillVal / 100));
            if (infillVal === 0) solidFactor = 0.3; // –¢—ñ–ª—å–∫–∏ —Å—Ç—ñ–Ω–∫–∏
            if (infillVal === 100) solidFactor = 1.0;

            const finalWeight = baseVolume * density * solidFactor;

            // 2. –¶—ñ–Ω–∞
            let finalPrice = finalWeight * costPerGram;

            // 3. –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —è–∫–æ—Å—Ç—ñ (—á–∞—Å—É)
            // –¢–æ–Ω—à–∏–π —à–∞—Ä (0.1) = –¥–æ–≤—à–µ = –¥–æ—Ä–æ–∂—á–µ (x1.5)
            // –¢–æ–≤—Å—Ç–∏–π —à–∞—Ä (0.3) = —à–≤–∏–¥—à–µ = –¥–µ—à–µ–≤—à–µ (x0.9)
            let qualityFactor = 1.0;
            if (qualityVal === 0.1) qualityFactor = 1.5;
            if (qualityVal === 0.3) qualityFactor = 0.9;

            finalPrice = finalPrice * qualityFactor;
            if (finalPrice < 50) finalPrice = 50; // –ú—ñ–Ω—ñ–º–∞–ª–∫–∞

            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è UI
            document.getElementById('price').innerText = Math.round(finalPrice);
            document.getElementById('vol').innerText = baseVolume.toFixed(1);
            document.getElementById('weight').innerText = finalWeight.toFixed(1);

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
            orderData = {
                price: Math.round(finalPrice),
                weight: finalWeight.toFixed(1),
                vol: baseVolume.toFixed(1),
                material: matSelect.value,
                infill: infillVal + "%",
                quality: qualityVal + " –º–º",
                color: document.getElementById('color').value
            };
        }

        window.uploadAndClose = async function() {
            const btn = document.getElementById('confirm-btn');
            btn.innerText = "‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";
            btn.className = "btn btn-main btn-loading";

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                // –í–∞–Ω—Ç–∞–∂–∏–º–æ –Ω–∞ tmpfiles.org
                const res = await fetch('https://tmpfiles.org/api/v1/upload', { method: 'POST', body: formData });
                const json = await res.json();

                if (json.status === 'success') {
                    orderData.file_link = json.data.url.replace("tmpfiles.org/", "tmpfiles.org/dl/");
                    orderData.filename = selectedFile.name;
                    tg.sendData(JSON.stringify(orderData));
                } else {
                    throw new Error("API Error");
                }
            } catch (e) {
                // –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞, –≤—Å–µ –æ–¥–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–∞–Ω—ñ (—Ñ–∞–π–ª —Å–∫–∏–Ω—É—Ç—å –≤—Ä—É—á–Ω—É)
                if(confirm("–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª. –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –±–µ–∑ —Ñ–∞–π–ª—É? (–í–∏ —Å–∫–∏–Ω–µ—Ç–µ –π–æ–≥–æ –≤ —á–∞—Ç)")) {
                    orderData.file_link = null;
                    tg.sendData(JSON.stringify(orderData));
                } else {
                    btn.innerText = "‚ùå –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑";
                    btn.className = "btn btn-main";
                }
            }
        };
    </script>
</body>
</html>
