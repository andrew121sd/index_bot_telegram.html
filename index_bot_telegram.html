<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Calculator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        body { margin: 0; background-color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        #canvas-container { flex-grow: 1; position: relative; width: 100%; background: radial-gradient(circle, #f0f0f0 0%, #c0c0c0 100%); }
        #viewer { width: 100%; height: 100%; }
        
        .controls { 
            padding: 20px; 
            background: #ffffff; 
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.1); 
            z-index: 10;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        .stats-row { display: flex; justify-content: space-between; padding: 10px; background: #f5f5f5; border-radius: 10px; font-size: 14px; color: #333; }
        .price-big { text-align: center; font-size: 24px; font-weight: 800; color: #3390ec; margin: 5px 0; }

        .btn { 
            width: 100%; padding: 16px; border: none; border-radius: 12px; 
            font-size: 16px; font-weight: 600; cursor: pointer; text-align: center;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-main { background: #3390ec; color: white; display: none; } /* –°—Ö–æ–≤–∞–Ω–∞ —Å–ø–æ—á–∞—Ç–∫—É */
        .btn-upload { background: #333; color: white; display: block; }
        
        input[type="file"] { display: none; }
        
        /* –õ–æ–∞–¥–µ—Ä */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 14px; color: #666; display: none;
        }
    </style>
</head>
<body>

    <div id="canvas-container">
        <div id="loader">‚è≥ –û–±—Ä–æ–±–∫–∞ –º–æ–¥–µ–ª—ñ...</div>
        <div id="viewer"></div>
    </div>

    <div class="controls">
        <div id="info-panel" style="display:none;">
            <div class="price-big">‚âà <span id="price">0</span> –≥—Ä–Ω</div>
            <div class="stats-row">
                <span>üì¶ –û–±'—î–º: <b id="vol">0</b> —Å–º¬≥</span>
                <span>‚öñÔ∏è –í–∞–≥–∞: <b id="weight">0</b> –≥</span>
            </div>
        </div>

        <label for="file-upload" class="btn btn-upload" id="upload-label">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª</label>
        <input type="file" id="file-upload" accept=".stl,.obj">
        
        <button class="btn btn-main" id="confirm-btn" onclick="sendOrder()">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { STLLoader } from 'three/addons/loaders/STLLoader.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';

        const tg = window.Telegram.WebApp;
        tg.expand();

        let scene, camera, renderer, mesh, controls;
        let orderData = null;

        init();

        function init() {
            const container = document.getElementById('viewer');

            // 1. –°—Ü–µ–Ω–∞
            scene = new THREE.Scene();
            // –î–æ–¥–∞—î–º–æ —Å—ñ—Ç–∫—É, —â–æ–± –≤–∏ –±–∞—á–∏–ª–∏, —â–æ —Å—Ü–µ–Ω–∞ –ø—Ä–∞—Ü—é—î, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –º–æ–¥–µ–ª—ñ –Ω–µ–º–∞—î
            const grid = new THREE.GridHelper(200, 20, 0x888888, 0xbbbbbb);
            scene.add(grid);

            // 2. –°–≤—ñ—Ç–ª–æ (–î—É–∂–µ —è—Å–∫—Ä–∞–≤–µ)
            const ambLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(50, 50, 50);
            scene.add(dirLight);
            const dirLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
            dirLight2.position.set(-50, 20, -50);
            scene.add(dirLight2);

            // 3. –ö–∞–º–µ—Ä–∞
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 2000);
            camera.position.set(50, 50, 50); // –ü–æ—á–∞—Ç–∫–æ–≤–∞ –ø–æ–∑–∏—Ü—ñ—è

            // 4. –†–µ–Ω–¥–µ—Ä–µ—Ä
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // 5. –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;

            animate();
            
            // –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å
            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // --- –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø ---
        document.getElementById('file-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('loader').style.display = 'block';
            controls.autoRotate = false;

            const reader = new FileReader();
            const ext = file.name.split('.').pop().toLowerCase();

            reader.onload = function(event) {
                try {
                    if (mesh) scene.remove(mesh);
                    
                    const content = event.target.result;
                    let geometry;

                    if (ext === 'stl') {
                        const loader = new STLLoader();
                        geometry = loader.parse(content);
                        setupMesh(geometry);
                    } else if (ext === 'obj') {
                        const loader = new OBJLoader();
                        const object = loader.parse(content);
                        object.traverse((child) => {
                            if (child.isMesh) geometry = child.geometry;
                        });
                        if (geometry) setupMesh(geometry);
                        else throw new Error("OBJ –ø—É—Å—Ç–∏–π");
                    }
                } catch (err) {
                    alert("–ü–æ–º–∏–ª–∫–∞: " + err.message);
                    document.getElementById('loader').style.display = 'none';
                }
            };

            if (ext === 'stl') reader.readAsArrayBuffer(file);
            else reader.readAsText(file);
        });

        function setupMesh(geometry) {
            // –¶–µ–Ω—Ç—Ä—É—î–º–æ –≥–µ–æ–º–µ—Ç—Ä—ñ—é
            geometry.computeBoundingBox();
            geometry.center();

            // –ú–∞—Ç–µ—Ä—ñ–∞–ª (–Ø—Å–∫—Ä–∞–≤–æ —Å–∏–Ω—ñ–π)
            const material = new THREE.MeshPhongMaterial({ 
                color: 0x2196f3, 
                specular: 0x111111, 
                shininess: 200 
            });

            mesh = new THREE.Mesh(geometry, material);
            mesh.rotation.x = -Math.PI / 2; // STL –∑–∞–∑–≤–∏—á–∞–π –ª–µ–∂–∞—Ç—å
            scene.add(mesh);

            // –ê–í–¢–û-–ú–ê–°–®–¢–ê–ë –ö–ê–ú–ï–†–ò
            geometry.computeBoundingBox();
            const size = new THREE.Vector3();
            geometry.boundingBox.getSize(size);
            const maxDim = Math.max(size.x, size.y, size.z);
            
            // –í—ñ–¥—Å—É–≤–∞—î–º–æ –∫–∞–º–µ—Ä—É
            const fov = camera.fov * (Math.PI / 180);
            let cameraZ = Math.abs(maxDim / 2 * Math.tan(fov * 2)) * 2.5;
            
            camera.position.set(cameraZ, cameraZ, cameraZ);
            camera.lookAt(0, 0, 0);
            controls.target.set(0, 0, 0);

            // –†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏
            calculate(geometry);
            
            document.getElementById('loader').style.display = 'none';
        }

        function calculate(geometry) {
            // –ü—Ä–∏–±–ª–∏–∑–Ω–∏–π –æ–±'—î–º (BufferGeometry)
            let vol = 0;
            const pos = geometry.attributes.position;
            const p1 = new THREE.Vector3(), p2 = new THREE.Vector3(), p3 = new THREE.Vector3();
            for (let i = 0; i < pos.count; i += 3) {
                p1.fromBufferAttribute(pos, i);
                p2.fromBufferAttribute(pos, i + 1);
                p3.fromBufferAttribute(pos, i + 2);
                vol += p1.dot(p2.cross(p3)) / 6.0;
            }
            vol = Math.abs(vol) / 1000; // —Å–º3

            const weight = vol * 1.24;
            let price = weight * 3.5;
            if (price < 50) price = 50;

            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è UI
            document.getElementById('vol').innerText = vol.toFixed(2);
            document.getElementById('weight').innerText = weight.toFixed(1);
            document.getElementById('price').innerText = Math.round(price);

            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–∞–Ω–µ–ª—å —ñ –∫–Ω–æ–ø–∫—É
            document.getElementById('info-panel').style.display = 'block';
            document.getElementById('upload-label').innerText = "üìÇ –û–±—Ä–∞—Ç–∏ —ñ–Ω—à–∏–π —Ñ–∞–π–ª";
            document.getElementById('upload-label').style.background = "#f0f0f0";
            document.getElementById('upload-label').style.color = "#333";
            document.getElementById('confirm-btn').style.display = 'block';

            // –ì–æ—Ç—É—î–º–æ –¥–∞–Ω—ñ
            orderData = { vol: vol.toFixed(2), weight: weight.toFixed(1), price: Math.round(price) };
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ (–ì–ª–æ–±–∞–ª—å–Ω–∞)
        window.sendOrder = function() {
            if (!orderData) {
                alert("–°–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –º–æ–¥–µ–ª—å!");
                return;
            }
            try {
                tg.sendData(JSON.stringify(orderData));
                // –ü—Ä–æ –∑–∞–ø–∞—Å –∑–∞–∫—Ä–∏–≤–∞—î–º–æ
                setTimeout(() => tg.close(), 100); 
            } catch (e) {
                alert("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: " + e);
            }
        };
    </script>
</body>
</html>
