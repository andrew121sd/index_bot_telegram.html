<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Calc</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #e0e0e0; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; }
        #top-panel { background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); transform: translateY(-150%); transition: transform 0.3s ease; pointer-events: auto; text-align: center; }
        #top-panel.visible { transform: translateY(0); }
        .price-tag { font-size: 28px; font-weight: 800; color: #3390ec; margin-bottom: 8px; }
        .stats-grid { display: flex; justify-content: center; gap: 20px; font-size: 14px; color: #333; }
        #bottom-panel { pointer-events: auto; width: 100%; padding-bottom: 20px; }
        .btn { display: flex; justify-content: center; align-items: center; width: 100%; padding: 18px; margin-top: 10px; border: none; border-radius: 14px; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.2s; }
        .btn-upload { background: #333; color: white; }
        .btn-confirm { background: #3390ec; color: white; display: none; }
        .btn-loading { background: #666; cursor: wait; }
        input[type="file"] { display: none; }
        #loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 15px 25px; border-radius: 30px; z-index: 20; display: none; font-weight: bold; }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="ui-layer">
        <div id="top-panel">
            <div class="price-tag">‚âà <span id="price">0</span> –≥—Ä–Ω</div>
            <div class="stats-grid"><span>üì¶ <b id="vol">0</b> —Å–º¬≥</span><span>‚öñÔ∏è <b id="weight">0</b> –≥</span></div>
        </div>
        <div id="bottom-panel">
            <label for="file-upload" class="btn btn-upload" id="upload-btn">üìÇ –û–±—Ä–∞—Ç–∏ STL/OBJ</label>
            <input type="file" id="file-upload" accept=".stl,.obj">
            <button class="btn btn-confirm" id="confirm-btn" onclick="uploadAndClose()">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
        </div>
    </div>
    <div id="loader">‚è≥ –û–±—Ä–æ–±–∫–∞...</div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { STLLoader } from 'three/addons/loaders/STLLoader.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';

        const tg = window.Telegram.WebApp;
        tg.expand();

        let scene, camera, renderer, mesh, controls;
        let orderData = null;
        let selectedFile = null;

        init();

        function init() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene(); scene.background = new THREE.Color(0xdcdcdc);
            const grid = new THREE.GridHelper(200, 40, 0x000000, 0x000000); grid.material.opacity = 0.1; grid.material.transparent = true; scene.add(grid);
            const amb = new THREE.AmbientLight(0xffffff, 0.6); scene.add(amb);
            const spot = new THREE.SpotLight(0xffffff, 1); spot.position.set(50, 80, 50); scene.add(spot);
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000); camera.position.set(30, 30, 30);
            renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping = true; controls.autoRotate = true;
            animate();
            window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        }
        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }

        document.getElementById('file-upload').addEventListener('change', function(e) {
            selectedFile = e.target.files[0];
            if (!selectedFile) return;
            document.getElementById('loader').style.display = 'block'; controls.autoRotate = false;
            const reader = new FileReader(); const ext = selectedFile.name.split('.').pop().toLowerCase();
            reader.onload = function(event) {
                try {
                    if (mesh) scene.remove(mesh);
                    const content = event.target.result;
                    if (ext === 'stl') { const l = new STLLoader(); setupModel(l.parse(content)); }
                    else if (ext === 'obj') { const l = new OBJLoader(); const o = l.parse(content); let g; o.traverse(c=>{if(c.isMesh)g=c.geometry}); if(g)setupModel(g); }
                } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞: " + e.message); document.getElementById('loader').style.display = 'none'; }
            };
            if (ext === 'stl') reader.readAsArrayBuffer(selectedFile); else reader.readAsText(selectedFile);
        });

        function setupModel(geo) {
            geo.computeBoundingBox(); geo.center();
            const mat = new THREE.MeshStandardMaterial({ color: 0xff9800, roughness: 0.4 });
            mesh = new THREE.Mesh(geo, mat); mesh.rotation.x = -Math.PI / 2;
            geo.computeBoundingBox(); mesh.position.y = -geo.boundingBox.min.z;
            scene.add(mesh);
            const size = geo.boundingBox.getSize(new THREE.Vector3());
            const max = Math.max(size.x, size.y, size.z);
            camera.position.set(max*2.5, max*2.5, max*2.5); camera.lookAt(0,0,0); controls.target.set(0,0,0);
            
            let vol = 0; const pos = geo.attributes.position;
            const p1=new THREE.Vector3(),p2=new THREE.Vector3(),p3=new THREE.Vector3();
            for(let i=0;i<pos.count;i+=3){ p1.fromBufferAttribute(pos,i); p2.fromBufferAttribute(pos,i+1); p3.fromBufferAttribute(pos,i+2); vol+=p1.dot(p2.cross(p3))/6.0; }
            vol = Math.abs(vol)/1000;
            const weight = vol * 1.24; let price = weight * 3.5; if(price<50) price=50;

            document.getElementById('vol').innerText = vol.toFixed(2);
            document.getElementById('weight').innerText = weight.toFixed(1);
            document.getElementById('price').innerText = Math.round(price);
            document.getElementById('top-panel').classList.add('visible');
            document.getElementById('upload-btn').style.display = 'none';
            document.getElementById('confirm-btn').style.display = 'block';
            document.getElementById('loader').style.display = 'none';

            orderData = { vol: vol.toFixed(2), weight: weight.toFixed(1), price: Math.round(price) };
        }

        // üî• –•–ò–¢–†–ò–ô –¢–†–Æ–ö: –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–∞ file.io —ñ –ø–µ—Ä–µ–¥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –±–æ—Ç—É
        window.uploadAndClose = async function() {
            if (!selectedFile || !orderData) return alert("–§–∞–π–ª –Ω–µ –æ–±—Ä–∞–Ω–æ");
            
            const btn = document.getElementById('confirm-btn');
            btn.innerText = "‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";
            btn.className = "btn btn-loading";

            const formData = new FormData();
            formData.append('file', selectedFile);
            // –°—Ç–∞–≤–∏–º–æ —Ç–µ—Ä–º—ñ–Ω –¥—ñ—ó —Ñ–∞–π–ª—É 1 –¥–µ–Ω—å (–∞–±–æ 1 —Å–∫–∞—á—É–≤–∞–Ω–Ω—è)
            formData.append('expires', '1d'); 

            try {
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π API file.io
                const response = await fetch('https://file.io', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ —Ö–º–∞—Ä–∏");
                const result = await response.json();
                
                if (result.success) {
                    // –î–æ–¥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–æ –¥–∞–Ω–∏—Ö
                    orderData.file_link = result.link;
                    orderData.filename = selectedFile.name;
                    
                    // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –±–æ—Ç—É –¶–ò–§–†–ò + –ü–û–°–ò–õ–ê–ù–ù–Ø
                    tg.sendData(JSON.stringify(orderData));
                } else {
                    throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è");
                }

            } catch (e) {
                alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: " + e.message);
                btn.innerText = "‚ùå –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑";
                btn.className = "btn btn-confirm";
            }
        };
    </script>
</body>
</html>
