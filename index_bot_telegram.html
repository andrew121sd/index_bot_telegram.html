<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Calc</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background-color: #212121; color: white; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        #canvas-container { flex-grow: 1; position: relative; width: 100%; overflow: hidden; }
        #viewer { width: 100%; height: 100%; }
        
        .controls { 
            padding: 20px; background: #1c1c1e; 
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5); z-index: 10;
        }
        
        .stats { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 14px; color: #aaa; }
        .stats b { color: white; font-size: 16px; }
        .price-tag { text-align: center; font-size: 20px; margin-bottom: 15px; color: #4caf50; font-weight: bold; }

        .btn { 
            width: 100%; padding: 15px; border: none; border-radius: 12px; 
            font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; display: block;
        }
        .btn-blue { background: #3390ec; color: white; margin-bottom: 10px; }
        .btn-outline { background: transparent; border: 2px dashed #555; color: #aaa; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div id="canvas-container">
        <div id="viewer"></div>
    </div>

    <div class="controls">
        <div id="info-panel" style="display:none;">
            <div class="price-tag">‚âà <span id="price">0</span> –≥—Ä–Ω</div>
            <div class="stats">
                <div>–û–±'—î–º: <b id="vol">0</b> —Å–º¬≥</div>
                <div>–í–∞–≥–∞: <b id="weight">0</b> –≥</div>
            </div>
            <button class="btn btn-blue" onclick="sendOrder()">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
        </div>
        
        <label for="file-upload" class="btn btn-outline" id="upload-btn">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª (STL/OBJ)</label>
        <input type="file" id="file-upload" accept=".stl,.obj">
    </div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.127.0/build/three.module.js';
        import { OrbitControls } from 'https://unpkg.com/three@0.127.0/examples/jsm/controls/OrbitControls.js';
        import { STLLoader } from 'https://unpkg.com/three@0.127.0/examples/jsm/loaders/STLLoader.js';
        import { OBJLoader } from 'https://unpkg.com/three@0.127.0/examples/jsm/loaders/OBJLoader.js';

        const tg = window.Telegram.WebApp;
        tg.expand();

        let scene, camera, renderer, mesh, controls;
        let orderData = null;

        init();

        function init() {
            const container = document.getElementById('viewer');

            // –°—Ü–µ–Ω–∞
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x212121); // –¢–µ–º–Ω–æ-—Å—ñ—Ä–∏–π —Ñ–æ–Ω
            
            // –ö–∞–º–µ—Ä–∞
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 50, 100);

            // –°–≤—ñ—Ç–ª–æ (—â–æ–± –º–æ–¥–µ–ª—å –Ω–µ –±—É–ª–∞ —á–æ—Ä–Ω–æ—é)
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 20, 10);
            scene.add(dirLight);
            const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
            backLight.position.set(-10, -10, -20);
            scene.add(backLight);

            // –†–µ–Ω–¥–µ—Ä–µ—Ä
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight - 180); // –í—ñ–¥–Ω—ñ–º–∞—î–º–æ –≤–∏—Å–æ—Ç—É –ø–∞–Ω–µ–ª—ñ
            container.appendChild(renderer.domElement);

            // –ö–æ–Ω—Ç—Ä–æ–ª–∏ (–∫—Ä—É—Ç–∏–ª–∫–∞)
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É
        document.getElementById('file-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            const ext = file.name.split('.').pop().toLowerCase();

            reader.onload = function(event) {
                if (mesh) scene.remove(mesh);
                const content = event.target.result;

                try {
                    if (ext === 'stl') {
                        const loader = new STLLoader();
                        const geometry = loader.parse(content);
                        displayMesh(geometry);
                    } else if (ext === 'obj') {
                        const loader = new OBJLoader();
                        const object = loader.parse(content);
                        let geometry = null;
                        object.traverse(child => { if (child.isMesh) geometry = child.geometry; });
                        if (geometry) displayMesh(geometry);
                    }
                } catch (err) { alert('–ü–æ–º–∏–ª–∫–∞ —Ñ–∞–π–ª—É: ' + err); }
            };

            if (ext === 'stl') reader.readAsArrayBuffer(file);
            else reader.readAsText(file);
        });

        function displayMesh(geometry) {
            // –¶–µ–Ω—Ç—Ä—É—î–º–æ –≥–µ–æ–º–µ—Ç—Ä—ñ—é
            geometry.computeBoundingBox();
            geometry.center();

            // –ú–∞—Ç–µ—Ä—ñ–∞–ª (—Å—ñ—Ä–∏–π –ø–ª–∞—Å—Ç–∏–∫)
            const material = new THREE.MeshStandardMaterial({ 
                color: 0xaaaaaa, 
                roughness: 0.5, 
                metalness: 0.1 
            });

            mesh = new THREE.Mesh(geometry, material);
            
            // –ü–æ–≤–æ—Ä–æ—Ç (STL —á–∞—Å—Ç–æ –ª–µ–∂–∞—Ç—å –Ω–∞ –±–æ—Ü—ñ)
            mesh.rotation.x = -Math.PI / 2;
            scene.add(mesh);

            // –ê–í–¢–û-–ö–ê–ú–ï–†–ê (–ù–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–µ!)
            geometry.computeBoundingBox();
            const size = new THREE.Vector3();
            geometry.boundingBox.getSize(size);
            const maxDim = Math.max(size.x, size.y, size.z);
            const fov = camera.fov * (Math.PI / 180);
            let cameraZ = Math.abs(maxDim / 2 * Math.tan(fov * 2));
            cameraZ *= 2.0; // –í—ñ–¥–ª—ñ—Ç–∞—î–º–æ —Ç—Ä–æ—Ö–∏ –¥–∞–ª—ñ
            
            camera.position.set(0, maxDim, cameraZ);
            camera.lookAt(0, 0, 0);
            controls.target.set(0, 0, 0);

            // –†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏
            calculate(geometry);
            
            // –•–æ–≤–∞—î–º–æ –∫–Ω–æ–ø–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, –ø–æ–∫–∞–∑—É—î–º–æ —ñ–Ω—Ñ–æ
            document.getElementById('upload-btn').style.display = 'none';
            document.getElementById('info-panel').style.display = 'block';
        }

        function calculate(geometry) {
            // –°–ø—Ä–æ—â–µ–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –æ–±'—î–º—É –¥–ª—è –ø—Ä–∏–∫–ª–∞–¥—É
            // (–í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—ñ —Ç—Ä–µ–±–∞ —Å–∫–ª–∞–¥–Ω—ñ—à–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è BufferGeometry, –∞–ª–µ –¥–ª—è —Ç–µ—Å—Ç—É –≤–∏—Å—Ç–∞—á–∏—Ç—å)
            let vol = 0;
            const pos = geometry.attributes.position;
            if (pos) {
                const p1 = new THREE.Vector3(), p2 = new THREE.Vector3(), p3 = new THREE.Vector3();
                for (let i = 0; i < pos.count; i += 3) {
                    p1.fromBufferAttribute(pos, i);
                    p2.fromBufferAttribute(pos, i + 1);
                    p3.fromBufferAttribute(pos, i + 2);
                    vol += p1.dot(p2.cross(p3)) / 6.0;
                }
            }
            vol = Math.abs(vol) / 1000; // —Å–º3
            if (vol < 0.1) vol = 0.0; // –ü–æ—Ö–∏–±–∫–∞

            const weight = vol * 1.24; // PLA
            let price = weight * 3.5; 
            if (price > 0 && price < 50) price = 50;

            document.getElementById('vol').innerText = vol.toFixed(2);
            document.getElementById('weight').innerText = weight.toFixed(1);
            document.getElementById('price').innerText = Math.round(price);

            orderData = { vol: vol.toFixed(2), weight: weight.toFixed(1), price: Math.round(price) };
        }

        window.sendOrder = function() {
            if (orderData) {
                tg.sendData(JSON.stringify(orderData));
            } else {
                alert("–°–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –º–æ–¥–µ–ª—å!");
            }
        };
    </script>
</body>
</html>
