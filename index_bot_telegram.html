<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Calc Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #e0e0e0; }
        
        #canvas-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; 
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; 
        }
        
        /* –í–µ—Ä—Ö–Ω—è –ø–∞–Ω–µ–ª—å: –¶—ñ–Ω–∞ */
        #top-panel { 
            background: rgba(255, 255, 255, 0.95); padding: 15px; margin: 15px; border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); transform: translateY(-150%); 
            transition: transform 0.3s ease; pointer-events: auto; text-align: center; 
        }
        #top-panel.visible { transform: translateY(0); }
        .price-tag { font-size: 32px; font-weight: 800; color: #3390ec; margin-bottom: 5px; }
        .stats-row { display: flex; justify-content: center; gap: 15px; font-size: 13px; color: #555; }

        /* –ù–∏–∂–Ω—è –ø–∞–Ω–µ–ª—å: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è */
        #bottom-panel { 
            background: white; border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 20px; pointer-events: auto; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            transform: translateY(150%); transition: transform 0.3s ease;
        }
        #bottom-panel.visible { transform: translateY(0); }

        /* –°–µ–ª–µ–∫—Ç–æ—Ä–∏ */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .control-group { display: flex; flex-direction: column; }
        .control-label { font-size: 12px; color: #888; margin-bottom: 4px; font-weight: 600; }
        
        select {
            width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ddd;
            background: #f9f9f9; font-size: 14px; font-weight: 500; appearance: none;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { 
            display: flex; justify-content: center; align-items: center; width: 100%; 
            padding: 16px; border: none; border-radius: 12px; 
            font-size: 16px; font-weight: 700; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: 0.2s; 
        }
        .btn-upload { background: #222; color: white; margin-top: 10px;}
        .btn-confirm { background: #3390ec; color: white; margin-top: 10px;}
        .btn-loading { background: #8e8e93; cursor: wait; pointer-events: none; margin-top: 10px;}
        
        input[type="file"] { display: none; }
        #loader { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(0,0,0,0.8); color: white; padding: 12px 20px; 
            border-radius: 20px; z-index: 20; display: none; font-weight: bold; font-size: 14px;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ —Ü–µ–Ω—Ç—Ä—É –µ–∫—Ä–∞–Ω—É —Å–ø–æ—á–∞—Ç–∫—É */
        #center-upload {
            pointer-events: auto; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); width: 200px; text-align: center;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div id="top-panel">
            <div class="price-tag"><span id="price">0</span> –≥—Ä–Ω</div>
            <div class="stats-row">
                <span>üì¶ <b id="vol">0</b> —Å–º¬≥</span> | <span>‚öñÔ∏è <b id="weight">0</b> –≥</span>
            </div>
        </div>

        <div id="center-upload">
            <label for="file-upload" class="btn btn-upload">üìÇ –û–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª</label>
        </div>

        <div id="bottom-panel">
            <div class="settings-grid">
                <div class="control-group">
                    <label class="control-label">–ú–∞—Ç–µ—Ä—ñ–∞–ª</label>
                    <select id="material" onchange="recalc()">
                        <option value="PLA" data-cost="3.5" data-dens="1.24">PLA (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
                        <option value="PETG" data-cost="3.5" data-dens="1.27">PETG (–ú—ñ—Ü–Ω–∏–π)</option>
                        <option value="ABS" data-cost="4.0" data-dens="1.04">ABS (–¢–µ—Ö–Ω—ñ—á–Ω–∏–π)</option>
                        <option value="TPU" data-cost="6.0" data-dens="1.21">TPU (–ì–Ω—É—á–∫–∏–π)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label class="control-label">–ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è</label>
                    <select id="infill" onchange="recalc()">
                        <option value="20" selected>20% (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
                        <option value="100">100% (–õ–∏—Ç–∏–π)</option>
                        <option value="50">50% (–ü–æ—Å–∏–ª–µ–Ω–∏–π)</option>
                        <option value="0">0% (–ü—É—Å—Ç–∏–π)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label">–Ø–∫—ñ—Å—Ç—å (–®–∞—Ä)</label>
                    <select id="quality" onchange="recalc()">
                        <option value="0.2" selected>0.2 –º–º (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
                        <option value="0.1">0.1 –º–º (–î–µ—Ç–∞–ª—å–Ω–æ)</option>
                        <option value="0.3">0.3 –º–º (–ß–æ—Ä–Ω–æ–≤–∏–π)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label">–ö–æ–ª—ñ—Ä</label>
                    <select id="color">
                        <option value="–ß–æ—Ä–Ω–∏–π">–ß–æ—Ä–Ω–∏–π</option>
                        <option value="–ë—ñ–ª–∏–π">–ë—ñ–ª–∏–π</option>
                        <option value="–°—ñ—Ä–∏–π">–°—ñ—Ä–∏–π</option>
                        <option value="–Ü–Ω—à–∏–π">–Ü–Ω—à–∏–π</option>
                    </select>
                </div>
            </div>

            <label for="file-upload" class="btn btn-upload" style="background:#f0f0f0; color:#333; margin-bottom:5px; padding:10px; font-size:14px;">üîÑ –ó–º—ñ–Ω–∏—Ç–∏ —Ñ–∞–π–ª</label>
            <button class="btn btn-confirm" id="confirm-btn" onclick="uploadAndClose()">‚úÖ –ó–∞–º–æ–≤–∏—Ç–∏</button>
        </div>
    </div>
    
    <input type="file" id="file-upload" accept=".stl,.obj">
    <div id="loader">‚è≥ –û–±—Ä–æ–±–∫–∞...</div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { STLLoader } from 'three/addons/loaders/STLLoader.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';

        const tg = window.Telegram.WebApp;
        tg.expand();

        let scene, camera, renderer, mesh, controls;
        let baseVolume = 0; // –ß–∏—Å—Ç–∏–π –æ–±'—î–º –º–æ–¥–µ–ª—ñ
        let orderData = null;
        let selectedFile = null;

        init();

        function init() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene(); scene.background = new THREE.Color(0xdcdcdc);
            const grid = new THREE.GridHelper(200, 40, 0x000000, 0x000000); grid.material.opacity = 0.1; grid.material.transparent = true; scene.add(grid);
            const amb = new THREE.AmbientLight(0xffffff, 0.6); scene.add(amb);
            const spot = new THREE.SpotLight(0xffffff, 1); spot.position.set(50, 80, 50); scene.add(spot);
            
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000); 
            camera.position.set(30, 30, 30);
            
            renderer = new THREE.WebGLRenderer({ antialias: true }); 
            renderer.setSize(window.innerWidth, window.innerHeight); 
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            
            controls = new OrbitControls(camera, renderer.domElement); 
            controls.enableDamping = true; controls.autoRotate = true;
            
            animate();
            window.addEventListener('resize', () => { 
                camera.aspect = window.innerWidth / window.innerHeight; 
                camera.updateProjectionMatrix(); 
                renderer.setSize(window.innerWidth, window.innerHeight); 
            });
            
            // –†–æ–±–∏–º–æ —Ä–µ–∫–∞–ª—å–∫—É–ª—è—Ü—ñ—é –¥–æ—Å—Ç—É–ø–Ω–æ—é –≥–ª–æ–±–∞–ª—å–Ω–æ
            window.recalc = calculatePrice;
        }
        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }

        document.getElementById('file-upload').addEventListener('change', function(e) {
            selectedFile = e.target.files[0];
            if (!selectedFile) return;
            document.getElementById('loader').style.display = 'block'; controls.autoRotate = false;
            
            const reader = new FileReader(); 
            const ext = selectedFile.name.split('.').pop().toLowerCase();
            
            reader.onload = function(event) {
                try {
                    if (mesh) scene.remove(mesh);
                    const content = event.target.result;
                    if (ext === 'stl') { const l = new STLLoader(); setupModel(l.parse(content)); }
                    else if (ext === 'obj') { const l = new OBJLoader(); const o = l.parse(content); let g; o.traverse(c=>{if(c.isMesh)g=c.geometry}); if(g)setupModel(g); }
                } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞: " + e.message); document.getElementById('loader').style.display = 'none'; }
            };
            if (ext === 'stl') reader.readAsArrayBuffer(selectedFile); else reader.readAsText(selectedFile);
        });

        function setupModel(geo) {
            geo.computeBoundingBox(); geo.center();
            const mat = new THREE.MeshStandardMaterial({ color: 0x3390ec, roughness: 0.4 });
            mesh = new THREE.Mesh(geo, mat); mesh.rotation.x = -Math.PI / 2;
            geo.computeBoundingBox(); mesh.position.y = -geo.boundingBox.min.z;
            scene.add(mesh);
            
            const size = geo.boundingBox.getSize(new THREE.Vector3());
            const max = Math.max(size.x, size.y, size.z);
            camera.position.set(max*2.5, max*2.5, max*2.5); camera.lookAt(0,0,0); controls.target.set(0,0,0);
            
            // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –æ–±'—î–º—É
            let vol = 0; const pos = geo.attributes.position;
            const p1=new THREE.Vector3(),p2=new THREE.Vector3(),p3=new THREE.Vector3();
            for(let i=0;i<pos.count;i+=3){ p1.fromBufferAttribute(pos,i); p2.fromBufferAttribute(pos,i+1); p3.fromBufferAttribute(pos,i+2); vol+=p1.dot(p2.cross(p3))/6.0; }
            baseVolume = Math.abs(vol)/1000; // —Å–º3 (–±–∞–∑–æ–≤–∏–π)

            // –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('center-upload').style.display = 'none';
            document.getElementById('top-panel').classList.add('visible');
            document.getElementById('bottom-panel').classList.add('visible');
            document.getElementById('loader').style.display = 'none';

            calculatePrice();
        }

        // üî• –î–ò–ù–ê–ú–Ü–ß–ù–ò–ô –†–û–ó–†–ê–•–£–ù–û–ö üî•
        function calculatePrice() {
            if (baseVolume === 0) return;

            // –û—Ç—Ä–∏–º—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ —Å–µ–ª–µ–∫—Ç—ñ–≤
            const matSelect = document.getElementById('material');
            const infillSelect = document.getElementById('infill');
            const qualitySelect = document.getElementById('quality');
            const colorSelect = document.getElementById('color');

            // –î–∞–Ω—ñ –ø–ª–∞—Å—Ç–∏–∫—É
            const selectedOption = matSelect.options[matSelect.selectedIndex];
            const costPerGram = parseFloat(selectedOption.getAttribute('data-cost'));
            const density = parseFloat(selectedOption.getAttribute('data-dens'));
            
            const infillPercent = parseInt(infillSelect.value);
            
            // –§–æ—Ä–º—É–ª–∞ –≤–∞–≥–∏ (–°–ø—Ä–æ—â–µ–Ω–∞ –º–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–æ—Ä–∞—Ö—É–Ω–∫—É)
            // –í–∞–≥–∞ = (–û–±'—î–º * –©—ñ–ª—å–Ω—ñ—Å—Ç—å) * –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç_–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
            // 0.35 - —Ü–µ —Å—Ç—ñ–Ω–∫–∏ (—è–∫—ñ –∑–∞–≤–∂–¥–∏ 100%), —Ä–µ—à—Ç–∞ –º–∞—Å—à—Ç–∞–±—É—î—Ç—å—Å—è –≤—ñ–¥ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
            let infillFactor = 0.35 + (0.65 * (infillPercent / 100));
            if (infillPercent === 0) infillFactor = 0.25; // –¢—ñ–ª—å–∫–∏ —Å—Ç—ñ–Ω–∫–∏

            const finalWeight = baseVolume * density * infillFactor;
            
            let finalPrice = finalWeight * costPerGram;
            
            // –ù–∞—Ü—ñ–Ω–∫–∞ –∑–∞ —è–∫—ñ—Å—Ç—å (—Ç–æ–Ω—à–∏–π —à–∞—Ä = –¥–æ–≤—à–µ –¥—Ä—É–∫—É–≤–∞—Ç–∏ = –¥–æ—Ä–æ–∂—á–µ)
            // 0.2–º–º = 1.0x, 0.1–º–º = 1.4x, 0.3–º–º = 0.8x
            const layerHeight = parseFloat(qualitySelect.value);
            let speedFactor = 1.0;
            if (layerHeight === 0.1) speedFactor = 1.4;
            if (layerHeight === 0.3) speedFactor = 0.85;
            
            finalPrice = finalPrice * speedFactor;

            // –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —Ü—ñ–Ω–∞
            if (finalPrice < 50) finalPrice = 50;

            // –û–Ω–æ–≤–ª—é—î–º–æ UI
            document.getElementById('vol').innerText = baseVolume.toFixed(2);
            document.getElementById('weight').innerText = finalWeight.toFixed(1);
            document.getElementById('price').innerText = Math.round(finalPrice);
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
            orderData = {
                file_link: null,
                filename: selectedFile ? selectedFile.name : "model.stl",
                vol: baseVolume.toFixed(2),
                weight: finalWeight.toFixed(1),
                price: Math.round(finalPrice),
                material: matSelect.value,
                infill: infillPercent + "%",
                quality: layerHeight + " –º–º",
                color: colorSelect.value
            };
        }

        window.uploadAndClose = async function() {
            if (!selectedFile || !orderData) return alert("–§–∞–π–ª –Ω–µ –æ–±—Ä–∞–Ω–æ");
            
            const btn = document.getElementById('confirm-btn');
            btn.innerText = "‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";
            btn.className = "btn btn-loading";

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ tmpfiles.org
                const response = await fetch('https://tmpfiles.org/api/v1/upload', { 
                    method: 'POST', 
                    body: formData 
                });
                
                if (!response.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
                const result = await response.json();
                
                if (result.status === 'success') {
                    // –§–æ—Ä–º—É—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å–∫–∞—á—É–≤–∞–Ω–Ω—è
                    let dlUrl = result.data.url.replace("tmpfiles.org/", "tmpfiles.org/dl/");
                    orderData.file_link = dlUrl;
                    tg.sendData(JSON.stringify(orderData)); 
                } else {
                    throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è");
                }
            } catch (e) {
                // –ó–∞–ø–∞—Å–Ω–∏–π –ø–ª–∞–Ω
                if(confirm("–•–º–∞—Ä–∞ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞. –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –±–µ–∑ —Ñ–∞–π–ª—É (—Ñ–∞–π–ª —Å–∫–∏–Ω–µ—Ç–µ –≤—Ä—É—á–Ω—É)?")) {
                     orderData.file_link = null; 
                     tg.sendData(JSON.stringify(orderData));
                } else {
                    btn.innerText = "‚ùå –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑";
                    btn.className = "btn btn-confirm";
                }
            }
        };
    </script>
</body>
</html>
