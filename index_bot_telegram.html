<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Viewer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #e0e0e0; }
        
        #canvas-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; 
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; 
        }
        
        #top-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transform: translateY(-150%); transition: transform 0.3s ease;
            pointer-events: auto; text-align: center;
        }
        #top-panel.visible { transform: translateY(0); }
        
        .price-tag { font-size: 28px; font-weight: 800; color: #3390ec; margin-bottom: 8px; }
        .stats-grid { display: flex; justify-content: center; gap: 20px; font-size: 14px; color: #333; }

        #bottom-panel { pointer-events: auto; width: 100%; padding-bottom: 20px; }

        .btn {
            display: flex; justify-content: center; align-items: center;
            width: 100%; padding: 18px; margin-top: 10px;
            border: none; border-radius: 14px;
            font-size: 18px; font-weight: 600; 
            cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn:active { transform: scale(0.96); opacity: 0.9; }

        .btn-upload { background: #333; color: white; }
        .btn-confirm { background: #3390ec; color: white; display: none; }
        
        input[type="file"] { display: none; }
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white; padding: 15px 25px; border-radius: 30px;
            z-index: 20; display: none; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div id="top-panel">
            <div class="price-tag">‚âà <span id="price">0</span> –≥—Ä–Ω</div>
            <div class="stats-grid">
                <span>üì¶ <b id="vol">0</b> —Å–º¬≥</span>
                <span>‚öñÔ∏è <b id="weight">0</b> –≥</span>
            </div>
        </div>

        <div id="bottom-panel">
            <label for="file-upload" class="btn btn-upload" id="upload-btn">üìÇ –û–±—Ä–∞—Ç–∏ STL/OBJ</label>
            <input type="file" id="file-upload" accept=".stl,.obj">
            <button class="btn btn-confirm" id="confirm-btn" onclick="sendOrder()">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
        </div>
    </div>

    <div id="loader">‚è≥ –û–±—Ä–æ–±–∫–∞...</div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { STLLoader } from 'three/addons/loaders/STLLoader.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';

        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –Ω–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω

        let scene, camera, renderer, mesh, controls;
        let orderData = null;

        init();

        function init() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xeeeeee);
            
            // –°—ñ—Ç–∫–∞ –¥–ª—è –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—ó
            const grid = new THREE.GridHelper(200, 40, 0xcccccc, 0xdddddd);
            scene.add(grid);

            // –°–≤—ñ—Ç–ª–æ
            const ambient = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambient);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(50, 100, 50);
            scene.add(dirLight);

            // –ö–∞–º–µ—Ä–∞
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(30, 30, 30);

            // –†–µ–Ω–¥–µ—Ä
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;

            // –ö—É–± –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
            const geo = new THREE.BoxGeometry(5, 5, 5);
            const mat = new THREE.MeshStandardMaterial({ color: 0x3390ec });
            mesh = new THREE.Mesh(geo, mat);
            mesh.position.y = 2.5;
            scene.add(mesh);

            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // --- –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø ---
        document.getElementById('file-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('loader').style.display = 'block';
            controls.autoRotate = false;

            const reader = new FileReader();
            const ext = file.name.split('.').pop().toLowerCase();

            reader.onload = function(event) {
                try {
                    if (mesh) scene.remove(mesh);
                    const content = event.target.result;
                    
                    if (ext === 'stl') {
                        const loader = new STLLoader();
                        const geometry = loader.parse(content);
                        setupModel(geometry);
                    } else if (ext === 'obj') {
                        const loader = new OBJLoader();
                        const object = loader.parse(content);
                        let geometry = null;
                        object.traverse(c => { if (c.isMesh) geometry = c.geometry; });
                        if (geometry) setupModel(geometry);
                        else throw new Error("OBJ —Ñ–∞–π–ª –ø—É—Å—Ç–∏–π –∞–±–æ –±–µ–∑ –≥–µ–æ–º–µ—Ç—Ä—ñ—ó");
                    }
                } catch (err) {
                    alert("–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É: " + err.message);
                    document.getElementById('loader').style.display = 'none';
                }
            };

            if (ext === 'stl') reader.readAsArrayBuffer(file);
            else reader.readAsText(file);
        });

        function setupModel(geometry) {
            geometry.computeBoundingBox();
            geometry.center();

            const material = new THREE.MeshStandardMaterial({ 
                color: 0xff9800, roughness: 0.5, metalness: 0.1 
            });

            mesh = new THREE.Mesh(geometry, material);
            mesh.rotation.x = -Math.PI / 2;
            
            // –°—Ç–∞–≤–∏–º–æ –Ω–∞ "–ø—ñ–¥–ª–æ–≥—É"
            geometry.computeBoundingBox();
            mesh.position.y = -geometry.boundingBox.min.z; 
            scene.add(mesh);

            // –ö–∞–º–µ—Ä–∞
            const size = geometry.boundingBox.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const dist = maxDim * 2.5;
            camera.position.set(dist, dist, dist);
            camera.lookAt(0,0,0);
            controls.target.set(0,0,0);

            // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
            let vol = 0;
            const pos = geometry.attributes.position;
            const p1 = new THREE.Vector3(), p2 = new THREE.Vector3(), p3 = new THREE.Vector3();
            for (let i = 0; i < pos.count; i += 3) {
                p1.fromBufferAttribute(pos, i);
                p2.fromBufferAttribute(pos, i + 1);
                p3.fromBufferAttribute(pos, i + 2);
                vol += p1.dot(p2.cross(p3)) / 6.0;
            }
            vol = Math.abs(vol) / 1000;
            const weight = vol * 1.24;
            let price = weight * 3.5;
            if (price < 50) price = 50;

            // UI
            document.getElementById('vol').innerText = vol.toFixed(2);
            document.getElementById('weight').innerText = weight.toFixed(1);
            document.getElementById('price').innerText = Math.round(price);
            
            document.getElementById('top-panel').classList.add('visible');
            document.getElementById('upload-btn').style.display = 'none';
            document.getElementById('confirm-btn').style.display = 'block'; // –ü–û–ö–ê–ó–£–Ñ–ú–û –ö–ù–û–ü–ö–£
            document.getElementById('loader').style.display = 'none';

            orderData = { vol: vol.toFixed(2), weight: weight.toFixed(1), price: Math.round(price) };
        }

        // --- –ì–û–õ–û–í–ù–ê –§–£–ù–ö–¶–Ü–Ø –í–Ü–î–ü–†–ê–í–ö–ò ---
        window.sendOrder = function() {
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ 1: –ß–∏ —î –¥–∞–Ω—ñ?
            if (!orderData) {
                alert("–ü–æ–º–∏–ª–∫–∞: –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏!");
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ 2: –ß–∏ –±–∞—á–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –¢–µ–ª–µ–≥—Ä–∞–º?
            if (!tg) {
                alert("–ü–æ–º–∏–ª–∫–∞: Telegram WebApp API –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!");
                return;
            }

            try {
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–∞–Ω—ñ
                tg.sendData(JSON.stringify(orderData));
                
                // –Ø–∫—â–æ —Ü–µ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–æ, –≤—ñ–∫–Ω–æ –º–∞—î –∑–∞–∫—Ä–∏—Ç–∏—Å—å.
                // –Ø–∫—â–æ –Ω—ñ - –ø–æ–∫–∞–∂–µ–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.
                setTimeout(() => {
                    tg.close();
                }, 100);
            } catch (e) {
                alert("–ö–†–ò–¢–ò–ß–ù–ê –ü–û–ú–ò–õ–ö–ê: " + e.message);
            }
        };
    </script>
</body>
</html>
