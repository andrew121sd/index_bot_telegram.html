<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Viewer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #e0e0e0; }
        
        /* 3D –Ω–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω */
        #canvas-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        
        /* –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–≤–µ—Ä—Ö 3D */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; }
        
        /* –í–µ—Ä—Ö–Ω—è –ø–∞–Ω–µ–ª—å (–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞) */
        #top-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transform: translateY(-150%); /* –°—Ö–æ–≤–∞–Ω–æ */
            transition: transform 0.3s ease;
            pointer-events: auto;
        }
        #top-panel.visible { transform: translateY(0); }
        
        .price-tag { font-size: 28px; font-weight: 800; color: #3390ec; text-align: center; margin-bottom: 5px; }
        .stats-grid { display: flex; justify-content: space-around; font-size: 14px; color: #555; }

        /* –ù–∏–∂–Ω—è –ø–∞–Ω–µ–ª—å (–ö–Ω–æ–ø–∫–∏) */
        #bottom-panel { pointer-events: auto; width: 100%; padding-bottom: 20px;}

        .btn {
            display: flex; justify-content: center; align-items: center;
            width: 100%; padding: 16px; 
            border: none; border-radius: 14px;
            font-size: 16px; font-weight: 600; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.96); }

        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è */
        .btn-upload { background: #222; color: white; }
        
        /* –ö–Ω–æ–ø–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è */
        .btn-confirm { background: #3390ec; color: white; display: none; }
        
        input[type="file"] { display: none; }
        
        /* –õ–æ–∞–¥–µ—Ä */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px;
            z-index: 20; display: none; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        
        <div id="top-panel">
            <div class="price-tag">‚âà <span id="price">0</span> –≥—Ä–Ω</div>
            <div class="stats-grid">
                <span>üì¶ <b id="vol">0</b> —Å–º¬≥</span>
                <span>‚öñÔ∏è <b id="weight">0</b> –≥</span>
            </div>
        </div>

        <div id="bottom-panel">
            <label for="file-upload" class="btn btn-upload" id="upload-btn">üìÇ –û–±—Ä–∞—Ç–∏ STL/OBJ</label>
            <input type="file" id="file-upload" accept=".stl,.obj">
            
            <button class="btn btn-confirm" id="confirm-btn" onclick="sendOrder()">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
        </div>
    </div>

    <div id="loader">‚è≥ –û–±—Ä–æ–±–∫–∞...</div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { STLLoader } from 'three/addons/loaders/STLLoader.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';

        const tg = window.Telegram.WebApp;
        tg.expand();

        let scene, camera, renderer, mesh, controls;
        let orderData = null;

        init();

        function init() {
            const container = document.getElementById('canvas-container');

            // 1. –°—Ü–µ–Ω–∞
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xdcdcdc); // –°–≤—ñ—Ç–ª–æ-—Å—ñ—Ä–∏–π —Ñ–æ–Ω
            scene.fog = new THREE.Fog(0xdcdcdc, 10, 500);

            // –°—ñ—Ç–∫–∞ (–ø—ñ–¥–ª–æ–≥–∞)
            const grid = new THREE.GridHelper(200, 40, 0x000000, 0x000000);
            grid.material.opacity = 0.1;
            grid.material.transparent = true;
            scene.add(grid);

            // 2. –°–≤—ñ—Ç–ª–æ
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);
            const spot = new THREE.SpotLight(0xffffff, 1);
            spot.position.set(50, 80, 50);
            spot.castShadow = true;
            scene.add(spot);

            // 3. –ö–∞–º–µ—Ä–∞
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(30, 30, 30);

            // 4. –†–µ–Ω–¥–µ—Ä
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // 5. –ö–æ–Ω—Ç—Ä–æ–ª–∏
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;

            // üî• –î–û–î–ê–Ñ–ú–û –¢–ï–°–¢–û–í–ò–ô –ö–£–ë (–©–æ–± –≤–∏ –±–∞—á–∏–ª–∏, —â–æ –≤—Å–µ –ø—Ä–∞—Ü—é—î)
            const geom = new THREE.BoxGeometry(10, 10, 10);
            const mat = new THREE.MeshStandardMaterial({ color: 0x3390ec });
            mesh = new THREE.Mesh(geom, mat);
            mesh.position.y = 5;
            scene.add(mesh);

            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // --- –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø ---
        document.getElementById('file-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('loader').style.display = 'block';
            controls.autoRotate = false;

            const reader = new FileReader();
            const ext = file.name.split('.').pop().toLowerCase();

            reader.onload = function(event) {
                try {
                    // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π –º–µ—à (–∞–±–æ –∫—É–±)
                    if (mesh) scene.remove(mesh);

                    const content = event.target.result;
                    
                    if (ext === 'stl') {
                        const loader = new STLLoader();
                        const geometry = loader.parse(content);
                        setupModel(geometry);
                    } else if (ext === 'obj') {
                        const loader = new OBJLoader();
                        const object = loader.parse(content);
                        let geometry = null;
                        object.traverse(c => { if (c.isMesh) geometry = c.geometry; });
                        if (geometry) setupModel(geometry);
                    }
                } catch (err) {
                    alert("–ü–æ–º–∏–ª–∫–∞: " + err.message);
                    document.getElementById('loader').style.display = 'none';
                }
            };

            if (ext === 'stl') reader.readAsArrayBuffer(file);
            else reader.readAsText(file);
        });

        function setupModel(geometry) {
            geometry.computeBoundingBox();
            geometry.center();

            const material = new THREE.MeshStandardMaterial({ 
                color: 0xff9800, // –ü–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π –∫–æ–ª—ñ—Ä –º–æ–¥–µ–ª—ñ
                roughness: 0.4,
                metalness: 0.1
            });

            mesh = new THREE.Mesh(geometry, material);
            mesh.rotation.x = -Math.PI / 2;
            
            // –ü—ñ–¥–Ω—ñ–º–∞—î–º–æ –º–æ–¥–µ–ª—å –Ω–∞–¥ —Å—ñ—Ç–∫–æ—é
            geometry.computeBoundingBox();
            const minY = geometry.boundingBox.min.z; // Z –±–æ –º–∏ –ø–æ–≤–µ—Ä–Ω—É–ª–∏ –º–æ–¥–µ–ª—å
            mesh.position.y = -minY; // –°—Ç–∞–≤–∏–º–æ –Ω–∞ –ø—ñ–¥–ª–æ–≥—É

            scene.add(mesh);

            // –ê–≤—Ç–æ-–∑—É–º –∫–∞–º–µ—Ä–∏
            const size = geometry.boundingBox.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const dist = maxDim * 2.5;
            
            camera.position.set(dist, dist, dist);
            camera.lookAt(0,0,0);
            controls.target.set(0,0,0);

            calculatePrice(geometry);
            
            document.getElementById('loader').style.display = 'none';
        }

        function calculatePrice(geometry) {
            // –ü—Ä–æ—Å—Ç–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –æ–±'—î–º—É –¥–ª—è BufferGeometry
            let vol = 0;
            const pos = geometry.attributes.position;
            const p1 = new THREE.Vector3(), p2 = new THREE.Vector3(), p3 = new THREE.Vector3();
            for (let i = 0; i < pos.count; i += 3) {
                p1.fromBufferAttribute(pos, i);
                p2.fromBufferAttribute(pos, i + 1);
                p3.fromBufferAttribute(pos, i + 2);
                vol += p1.dot(p2.cross(p3)) / 6.0;
            }
            
            vol = Math.abs(vol) / 1000; // —Å–º3
            const weight = vol * 1.24; // PLA
            let price = weight * 3.5; // –≥—Ä–Ω
            if (price < 50) price = 50;

            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('vol').innerText = vol.toFixed(2);
            document.getElementById('weight').innerText = weight.toFixed(1);
            document.getElementById('price').innerText = Math.round(price);

            // –ê–Ω—ñ–º–∞—Ü—ñ—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
            document.getElementById('top-panel').classList.add('visible');
            document.getElementById('upload-btn').style.display = 'none';
            document.getElementById('confirm-btn').style.display = 'block';

            orderData = { vol: vol.toFixed(2), weight: weight.toFixed(1), price: Math.round(price) };
        }

        window.sendOrder = function() {
            if (!orderData) return;
            try {
                tg.sendData(JSON.stringify(orderData));
            } catch (e) {
                alert("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤ Telegram: " + e);
            }
        };
    </script>
</body>
</html>
